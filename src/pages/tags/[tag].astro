---
import Layout from "../../layouts/Layout.astro";
import { fetchStories } from "../../lib/notion";

export async function getStaticPaths() {
  const stories = await fetchStories();

  const tags = new Set<string>();

  stories.forEach((story: any) => {
    story.tags?.forEach((tag: string) => tags.add(tag));
  });

  return Array.from(tags).map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;
const stories = await fetchStories();

const filtered = stories.filter((s: any) =>
  s.tags?.includes(tag)
);
---

<Layout title={`#${tag}`}>
  <h1>#{tag}</h1>

  <ul>
    {filtered.map((story: any) => (
      <li>
        <a href={`/story/${story.slug}`}>{story.title}</a>
      </li>
    ))}
  </ul>
</Layout>