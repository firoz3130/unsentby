---
import Layout from "../../layouts/Layout.astro";
import { fetchStoryBySlug, fetchStories } from "../../lib/notion";
import type { PageObjectResponse,RichTextItemResponse } from "@notionhq/client/build/src/api-endpoints";

export const prerender = false;

function getRichText(prop: PageObjectResponse["properties"][string]) {
  if (!prop) return "";
  if (prop.type === "rich_text") {
    return prop.rich_text.map(t => t.plain_text).join("");
  }
  if (prop.type === "title") {
    return prop.title.map(t => t.plain_text).join("");
  }
  return "";
}

function getSelect(prop: PageObjectResponse["properties"][string]) {
  if (prop?.type === "select") {
    return prop.select?.name || "";
  }
  return "";
}

function getMultiSelect(prop: PageObjectResponse["properties"][string]) {
  if (prop?.type === "multi_select") {
    return prop.multi_select.map(t => t.name);
  }
  return [];
}

function getDate(prop: PageObjectResponse["properties"][string]) {
  if (prop?.type === "date") {
    return prop.date?.start || "";
  }
  return "";
}

export async function getStaticPaths() {
  const stories = await fetchStories();

  return stories.map((story: any) => ({
    params: { slug: story.slug },
  }));
}
const slug  = Astro.params.slug;
if (!slug) {
  throw new Error("Slug is required");
}
const page = await fetchStoryBySlug(slug);

if (!page) throw new Error("Story not found");

function isFullPage(page: any): page is PageObjectResponse {
  return page && "properties" in page;
}

if (!isFullPage(page)) {
  throw new Error("Story not found or invalid");
}

const props = page.properties;

const titleProp:any =
  props.title?.type === "rich_text" && props.title.rich_text.length ? props.title : null;

const story = {
  title: getRichText(titleProp) || "Untitled",
  content: getRichText(props.content),
  mood: getSelect(props.mood),
  tags: getMultiSelect(props.tags),
  date: getDate(props.date),
};
---

<Layout title={story.title}>
  <article class="story">
    <div class="story-header">
      <h1 class="story-title">{story.title}</h1>
      
      <div class="story-meta">
        <div class="meta-item">
          <span class="label">Published</span>
          <time datetime={story.date}>{new Date(story.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
        </div>
        {story.mood && (
          <div class="meta-item">
            <span class="label">Mood</span>
            <span class="mood-badge">{story.mood}</span>
          </div>
        )}
      </div>
    </div>

    <div class="divider"></div>

    <div class="content">
      {story.content.split("\n").map((p: string) => (
        p.trim() && <p>{p}</p>
      ))}
    </div>

    {story.tags && story.tags.length > 0 && (
      <>
        <div class="divider"></div>
        <div class="tags-section">
          <h3>Tags</h3>
          <div class="tags">
            {story.tags.map((tag: any) => (
              <a href={`/tags/${tag}`} class="tag-link">#{tag}</a>
            ))}
          </div>
        </div>
      </>
    )}

    <div class="story-footer">
      <a href="/" class="back-link">‚Üê Back to Stories</a>
    </div>
  </article>
</Layout>

<style>
.story {
  max-width: 750px;
  margin: 0 auto;
  padding: 4rem 2rem 6rem;
}

.story-header {
  margin-bottom: 3rem;
}

.story-title {
  font-size: 3rem;
  line-height: 1.2;
  margin-bottom: 2rem;
  background: linear-gradient(135deg, #fbbf24, #f87171, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-family: 'Lora', serif;
}

.story-meta {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
  align-items: center;
}

.meta-item {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.meta-item .label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  opacity: 0.6;
  font-weight: 600;
}

.meta-item time {
  font-size: 1.1rem;
  color: var(--text-primary);
  font-family: 'Lora', serif;
}

.mood-badge {
  display: inline-block;
  padding: 0.5rem 1.25rem;
  border-radius: 24px;
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(236, 72, 153, 0.3));
  border: 1px solid rgba(236, 72, 153, 0.3);
  font-weight: 500;
  font-size: 1rem;
  width: fit-content;
}

.divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
  margin: 3rem 0;
}

.content {
  font-size: 1.1rem;
  line-height: 1.9;
  font-family: 'Lora', serif;
  color: var(--text-primary);
}

.content p {
  margin-bottom: 1.75rem;
  text-align: justify;
}

.content p:first-of-type {
  font-size: 1.2rem;
  font-weight: 500;
  opacity: 0.95;
}

.tags-section {
  margin-top: 2rem;
}

.tags-section h3 {
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  opacity: 0.6;
  margin-bottom: 1rem;
  font-weight: 600;
}

.tags {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
}

.tag-link {
  padding: 0.5rem 1rem;
  border-radius: 20px;
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));
  border: 1px solid rgba(236, 72, 153, 0.3);
  color: var(--primary);
  transition: all 0.3s ease;
  font-weight: 500;
  font-size: 0.95rem;
}

.tag-link:hover {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(236, 72, 153, 0.4));
  border-color: rgba(236, 72, 153, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
}

.story-footer {
  margin-top: 4rem;
  padding-top: 2rem;
  border-top: 1px solid rgba(139, 92, 246, 0.2);
}

.back-link {
  display: inline-block;
  color: var(--primary);
  font-weight: 500;
  transition: all 0.3s ease;
  font-size: 1rem;
}

.back-link:hover {
  color: var(--accent);
  transform: translateX(-4px);
}

@media (max-width: 768px) {
  .story {
    padding: 2rem 1rem 4rem;
  }

  .story-title {
    font-size: 2rem;
    margin-bottom: 1.5rem;
  }

  .story-meta {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }

  .content {
    font-size: 1rem;
    line-height: 1.8;
  }

  .content p {
    margin-bottom: 1.5rem;
    text-align: left;
  }
}
</style>